# Cities Tab Implementation Plan

## Phase 1: Backend - Add City Statistics Command

### Affected Files

| File                              | Changes                                                                       |
| --------------------------------- | ----------------------------------------------------------------------------- |
| `src-tauri/src/lib.rs`            | Add `CityStatistics` struct, `CityInfo` struct, `get_city_statistics` command |
| `src/lib/api.ts`                  | Add `getCityStatistics` function                                              |
| `src/lib/types/CityStatistics.ts` | Auto-generated by ts-rs                                                       |
| `src/lib/types/CityInfo.ts`       | Auto-generated by ts-rs                                                       |

### Implementation

**1. Add types in `src-tauri/src/lib.rs`:**

```rust
/// City information for the Cities tab
#[derive(Serialize, TS)]
#[ts(export, export_to = "../../src/lib/types/")]
pub struct CityInfo {
    #[ts(type = "number")]
    pub city_id: i64,
    pub city_name: String,
    pub owner_nation: Option<String>,
    pub family: Option<String>,
    pub founded_turn: i32,
    pub is_capital: bool,
    pub citizens: i32,
    pub governor_name: Option<String>,
    pub culture_level: Option<i32>,
    pub growth_count: i32,
    pub unit_production_count: i32,
    pub specialist_count: i32,
    pub buy_tile_count: i32,
    pub hurry_civics_count: i32,
    pub hurry_money_count: i32,
    pub hurry_training_count: i32,
    pub hurry_population_count: i32,
}

#[derive(Serialize, TS)]
#[ts(export, export_to = "../../src/lib/types/")]
pub struct CityStatistics {
    pub cities: Vec<CityInfo>,
}
```

**2. Add command in `src-tauri/src/lib.rs`:**

```rust
/// Tauri command to get city statistics for a match
///
/// Returns all cities with their metrics for comparison charts
#[tauri::command]
async fn get_city_statistics(
    match_id: i64,
    pool: tauri::State<'_, db::connection::DbPool>,
) -> Result<CityStatistics, String> {
    pool.with_connection(|conn| {
        let mut stmt = conn.prepare(
            "SELECT
                c.city_id,
                c.city_name,
                p.nation as owner_nation,
                c.family,
                c.founded_turn,
                c.is_capital,
                c.citizens,
                gov.first_name as governor_name,
                cc.culture_level,
                c.growth_count,
                c.unit_production_count,
                c.specialist_count,
                c.buy_tile_count,
                c.hurry_civics_count,
                c.hurry_money_count,
                c.hurry_training_count,
                c.hurry_population_count
             FROM cities c
             LEFT JOIN players p ON c.player_id = p.player_id AND c.match_id = p.match_id
             LEFT JOIN characters gov ON c.governor_id = gov.character_id AND c.match_id = gov.match_id
             LEFT JOIN city_culture cc ON c.city_id = cc.city_id AND c.match_id = cc.match_id
                 AND cc.team_id = (SELECT team_id FROM players WHERE player_id = c.player_id AND match_id = c.match_id)
             WHERE c.match_id = ?
             ORDER BY c.city_name"
        )?;

        let cities = stmt
            .query_map([match_id], |row| {
                Ok(CityInfo {
                    city_id: row.get(0)?,
                    city_name: row.get(1)?,
                    owner_nation: row.get(2)?,
                    family: row.get(3)?,
                    founded_turn: row.get(4)?,
                    is_capital: row.get(5)?,
                    citizens: row.get(6)?,
                    governor_name: row.get(7)?,
                    culture_level: row.get(8)?,
                    growth_count: row.get(9)?,
                    unit_production_count: row.get(10)?,
                    specialist_count: row.get(11)?,
                    buy_tile_count: row.get(12)?,
                    hurry_civics_count: row.get(13)?,
                    hurry_money_count: row.get(14)?,
                    hurry_training_count: row.get(15)?,
                    hurry_population_count: row.get(16)?,
                })
            })?
            .collect::<std::result::Result<Vec<_>, _>>()?;

        Ok(CityStatistics { cities })
    })
    .context("Failed to get city statistics")
    .map_err(|e| e.to_string())
}
```

**3. Register command in `tauri::generate_handler![]` macro (around line 1569, after `get_law_adoption_history`):**

```rust
get_city_statistics,
```

**4. Add to `src/lib/api.ts`:**

```typescript
import type { CityStatistics } from "$lib/types/CityStatistics";

// In api object:
getCityStatistics: (matchId: number) =>
  invoke<CityStatistics>("get_city_statistics", { matchId }),
```

### Unit Tests

No complex logic requiring unit tests in this phase. The SQL query is straightforward with standard JOINs.

---

## Phase 2: Frontend - Add Cities Tab

### Affected Files

| File                                | Changes                                                |
| ----------------------------------- | ------------------------------------------------------ |
| `src/routes/game/[id]/+page.svelte` | Add Cities tab with comparison chart and details table |

### Implementation

**1. Add state and data fetching:**

```typescript
// Add imports
import type { CityStatistics } from "$lib/types/CityStatistics";
import type { CityInfo } from "$lib/types/CityInfo";

// Add state
let cityStatistics = $state<CityStatistics | null>(null);
let selectedCityMetric = $state<string>("citizens");

// Add to Promise.all in $effect:
api.getCityStatistics(matchId),

// Destructure in .then():
.then(([details, history, yields, logs, lawHistory, cityStats]) => {
  // ... existing assignments
  cityStatistics = cityStats;
})
```

**2. Define metric options and type-safe getter:**

```typescript
const CITY_METRICS = [
	{ value: "citizens", label: "Citizens" },
	{ value: "founded_turn", label: "Founded Turn" },
	{ value: "growth_count", label: "Growth Count" },
	{ value: "unit_production_count", label: "Units Produced" },
	{ value: "specialist_count", label: "Specialists Trained" },
	{ value: "buy_tile_count", label: "Tiles Bought" },
	{ value: "culture_level", label: "Culture Level" },
	{ value: "hurry_total", label: "Total Hurries" },
] as const;

// Type-safe metric value getter
function getCityMetricValue(city: CityInfo, metric: string): number {
	switch (metric) {
		case "hurry_total":
			return (
				city.hurry_civics_count +
				city.hurry_money_count +
				city.hurry_training_count +
				city.hurry_population_count
			);
		case "citizens":
			return city.citizens;
		case "founded_turn":
			return city.founded_turn;
		case "growth_count":
			return city.growth_count;
		case "unit_production_count":
			return city.unit_production_count;
		case "specialist_count":
			return city.specialist_count;
		case "buy_tile_count":
			return city.buy_tile_count;
		case "culture_level":
			return city.culture_level ?? 0;
		default:
			return 0;
	}
}

// Helper to get city bar color (matches existing getPlayerColor pattern)
function getCityColor(city: CityInfo, fallbackIndex: number): string {
	if (city.owner_nation) {
		const cleanNation = city.owner_nation.replace(/^NATION_/, "");
		const nationColor = getCivilizationColor(cleanNation);
		if (nationColor) return nationColor;
	}
	return getChartColor(fallbackIndex);
}
```

**3. Create chart option derived state:**

```typescript
const cityComparisonChartOption = $derived<EChartsOption | null>(
	cityStatistics
		? {
				...CHART_THEME,
				title: {
					...CHART_THEME.title,
					text:
						CITY_METRICS.find((m) => m.value === selectedCityMetric)?.label ??
						"City Comparison",
				},
				tooltip: { trigger: "axis" },
				xAxis: {
					type: "category",
					data: cityStatistics.cities.map((c) => c.city_name),
					axisLabel: { rotate: 45 },
				},
				yAxis: {
					type: "value",
					name: CITY_METRICS.find((m) => m.value === selectedCityMetric)?.label,
				},
				series: [
					{
						type: "bar",
						data: cityStatistics.cities.map((city, i) => ({
							value: getCityMetricValue(city, selectedCityMetric),
							itemStyle: { color: getCityColor(city, i) },
						})),
					},
				],
			}
		: null,
);
```

**4. Add Cities tab trigger (after Economics tab, before Game Settings):**

```svelte
<Tabs.Trigger
	value="cities"
	class="cursor-pointer border-2 border-b-0 border-r-0 border-black px-6 py-3 font-bold transition-all duration-200 hover:bg-tan-hover data-[state=active]:bg-[#35302B] data-[state=inactive]:bg-[#2a2622] data-[state=active]:text-tan data-[state=inactive]:text-tan"
>
	Cities
</Tabs.Trigger>
```

**5. Add Cities tab content:**

Note: Uses native `<select>` element styled to match the theme. This is simpler and more reliable than bits-ui Select for single-value selection.

```svelte
<Tabs.Content
	value="cities"
	class="tab-pane min-h-[400px] rounded-b-lg border-2 border-t-0 border-black p-8"
	style="background-color: #35302B;"
>
	<h2 class="mb-4 mt-0 font-bold text-tan">Cities</h2>

	{#if cityStatistics === null}
		<p class="p-8 text-center italic text-brown">Loading city data...</p>
	{:else if cityStatistics.cities.length === 0}
		<p class="p-8 text-center italic text-brown">No cities found</p>
	{:else}
		<!-- Metric Dropdown -->
		<div class="mb-4">
			<select
				bind:value={selectedCityMetric}
				class="w-48 cursor-pointer rounded border-2 border-black px-4 py-2 text-sm text-tan"
				style="background-color: #201a13;"
			>
				{#each CITY_METRICS as metric}
					<option value={metric.value}>{metric.label}</option>
				{/each}
			</select>
		</div>

		<!-- City Comparison Chart -->
		{#if cityComparisonChartOption}
			<ChartContainer
				option={cityComparisonChartOption}
				height="400px"
				title="City Comparison"
			/>
		{/if}

		<!-- City Details Table -->
		<h3 class="mb-4 mt-8 font-bold text-tan">City Details</h3>
		<div class="overflow-x-auto rounded-lg" style="background-color: #201a13;">
			<table class="w-full">
				<thead>
					<tr>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Name</th
						>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Owner</th
						>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Family</th
						>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Governor</th
						>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Pop</th
						>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Founded</th
						>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Capital</th
						>
						<th
							class="border-b-2 border-brown p-3 text-left font-bold text-brown"
							>Culture</th
						>
					</tr>
				</thead>
				<tbody>
					{#each cityStatistics.cities as city}
						<tr class="hover:bg-brown/20 transition-colors duration-200">
							<td
								class="border-brown/50 border-b p-3 text-left font-bold text-tan"
								>{city.city_name}</td
							>
							<td class="border-brown/50 border-b p-3 text-left text-tan"
								>{formatEnum(city.owner_nation, "NATION_")}</td
							>
							<td class="border-brown/50 border-b p-3 text-left text-tan"
								>{formatEnum(city.family, "FAMILY_")}</td
							>
							<td class="border-brown/50 border-b p-3 text-left text-tan"
								>{city.governor_name ?? "—"}</td
							>
							<td class="border-brown/50 border-b p-3 text-left text-tan"
								>{city.citizens}</td
							>
							<td class="border-brown/50 border-b p-3 text-left text-tan"
								>T{city.founded_turn}</td
							>
							<td class="border-brown/50 border-b p-3 text-left text-tan"
								>{city.is_capital ? "✓" : ""}</td
							>
							<td class="border-brown/50 border-b p-3 text-left text-tan"
								>{city.culture_level ?? "—"}</td
							>
						</tr>
					{/each}
				</tbody>
			</table>
		</div>
	{/if}
</Tabs.Content>
```

**6. Tab ordering note:**

The final tab order will be: Events → Laws & Technology → Economics → Cities → Game Settings.

Game Settings remains the last tab and keeps the `rounded-tr-lg` class. No class changes needed for the Settings tab trigger.

### Unit Tests

No complex logic requiring unit tests. The chart option derivation is straightforward mapping.
